<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Спортивный магазин</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .back-btn {
            position: absolute;
            left: 15px;
            top: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: none;
        }
        
        .screen {
            padding: 20px;
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .category-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .category-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #6a11cb;
        }
        
        .category-btn img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f0f0f0;
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f9f9f9;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .product-description {
            color: #7f8c8d;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .product-price {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.3rem;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .buy-btn {
            background: #2ecc71;
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 10px;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.2rem;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="back-btn" id="backBtn">←</button>
            <h1 id="screenTitle">Спортивный магазин</h1>
            <p id="screenSubtitle">Выберите категорию</p>
        </header>
        
        <!-- Экран выбора пола -->
        <div id="genderScreen" class="screen active">
            <div class="btn-grid">
                <button class="category-btn" data-gender="male">
                    <img src="https://placehold.co/100x100/6a11cb/FFFFFF?text=♂" alt="Мужской">
                    <span>Мужской</span>
                </button>
                <button class="category-btn" data-gender="female">
                    <img src="https://placehold.co/100x100/2575fc/FFFFFF?text=♀" alt="Женский">
                    <span>Женский</span>
                </button>
            </div>
        </div>
        
        <!-- Экран категорий -->
        <div id="categoryScreen" class="screen">
            <div class="btn-grid" id="categoryGrid"></div>
        </div>
        
        <!-- Экран товаров -->
        <div id="productsScreen" class="screen">
            <div id="productsContainer"></div>
            <div class="navigation">
                <button class="nav-btn" id="prevBtn">← Назад</button>
                <span id="pageInfo">Товар 1 из 1</span>
                <button class="nav-btn" id="nextBtn">Вперед →</button>
            </div>
        </div>
        
        <!-- Экран загрузки -->
        <div id="loadingScreen" class="screen">
            <div class="loading">Загрузка...</div>
        </div>
    </div>

    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Состояние приложения
        let currentState = {
            gender: null,
            category: null,
            products: [],
            currentProductIndex: 0
        };
        
        // Текущий активный экран
        let currentScreen = 'gender';
        
        // Элементы интерфейса
        const screens = {
            gender: document.getElementById('genderScreen'),
            category: document.getElementById('categoryScreen'),
            products: document.getElementById('productsScreen'),
            loading: document.getElementById('loadingScreen')
        };
        
        const backBtn = document.getElementById('backBtn');
        const categoryGrid = document.getElementById('categoryGrid');
        const productsContainer = document.getElementById('productsContainer');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');
        const screenTitle = document.getElementById('screenTitle');
        const screenSubtitle = document.getElementById('screenSubtitle');
        
        // Показ экрана
        function showScreen(screenName) {
            currentScreen = screenName;
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            screens[screenName].classList.add('active');
            
            // Показываем/скрываем кнопку "Назад"
            backBtn.style.display = (screenName !== 'gender') ? 'block' : 'none';
        }
        
        // Загрузка категорий
        async function loadCategories() {
            showScreen('loading');
            
            try {
                const response = await fetch(`/api/categories?gender=${currentState.gender}`);
                const categories = await response.json();
                
                categoryGrid.innerHTML = '';
                categories.forEach(category => {
                    const button = document.createElement('button');
                    button.className = 'category-btn';
                    button.innerHTML = `
                        <img src="https://placehold.co/100x100/3498db/FFFFFF?text=${encodeURIComponent(category.name.substring(0, 1))}" alt="${category.name}">
                        <span>${category.name}</span>
                    `;
                    button.dataset.id = category.id;
                    button.addEventListener('click', () => {
                        currentState.category = category.id;
                        loadProducts();
                    });
                    categoryGrid.appendChild(button);
                });
                
                screenTitle.textContent = 'Категории одежды';
                screenSubtitle.textContent = `Для ${currentState.gender === 'male' ? 'мужчин' : 'женщин'}`;
                showScreen('category');
            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
                alert('Не удалось загрузить категории');
                showScreen('gender');
            }
        }
        
        // Загрузка товаров
        async function loadProducts() {
            showScreen('loading');
            
            try {
                const response = await fetch(`/api/products?category_id=${currentState.category}`);
                currentState.products = await response.json();
                currentState.currentProductIndex = 0;
                
                if (currentState.products.length > 0) {
                    renderProduct(currentState.currentProductIndex);
                    showScreen('products');
                } else {
                    alert('В этой категории пока нет товаров');
                    showScreen('category');
                }
            } catch (error) {
                console.error('Ошибка загрузки товаров:', error);
                alert('Не удалось загрузить товары');
                showScreen('category');
            }
        }
        
        // Отображение товара
        function renderProduct(index) {
            const product = currentState.products[index];
            
            productsContainer.innerHTML = `
                <div class="product-card">
                    <img src="${product.image_url}" alt="${product.name}" class="product-image" onerror="this.src='https://placehold.co/600x400/e0e0e0/333333?text=Изображение+товара'">
                    <div class="product-info">
                        <h2 class="product-title">${product.name}</h2>
                        <p class="product-description">${product.description}</p>
                        <div class="product-price">${product.price.toFixed(2)} руб.</div>
                        <button class="buy-btn">Купить</button>
                    </div>
                </div>
            `;
            
            pageInfo.textContent = `Товар ${index + 1} из ${currentState.products.length}`;
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === currentState.products.length - 1;
            
            // Обработчик кнопки покупки
            document.querySelector('.buy-btn').addEventListener('click', () => {
                tg.showPopup({
                    title: 'Покупка товара',
                    message: `Вы уверены, что хотите купить "${product.name}" за ${product.price.toFixed(2)} руб.?`,
                    buttons: [
                        {id: 'cancel', type: 'cancel'},
                        {id: 'buy', type: 'ok', text: 'Купить'}
                    ]
                }, (buttonId) => {
                    if (buttonId === 'buy') {
                        tg.HapticFeedback.impactOccurred('heavy');
                        tg.showAlert(`Спасибо за покупку "${product.name}"!`);
                    }
                });
            });
        }
        
        // Обработчик кнопки "Назад"
        function handleBack() {
            if (currentScreen === 'products') {
                showScreen('category');
            } else if (currentScreen === 'category') {
                showScreen('gender');
            }
        }
        
        // Инициализация приложения
        function init() {
            // Обработчики кнопок выбора пола
            document.querySelectorAll('#genderScreen .category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentState.gender = e.currentTarget.dataset.gender;
                    loadCategories();
                });
            });
            
            // Обработчик кнопки "Назад"
            backBtn.addEventListener('click', handleBack);
            
            // Обработчики навигации по товарам
            prevBtn.addEventListener('click', () => {
                if (currentState.currentProductIndex > 0) {
                    currentState.currentProductIndex--;
                    renderProduct(currentState.currentProductIndex);
                }
            });
            
            nextBtn.addEventListener('click', () => {
                if (currentState.currentProductIndex < currentState.products.length - 1) {
                    currentState.currentProductIndex++;
                    renderProduct(currentState.currentProductIndex);
                }
            });
            
            // Начальный экран
            showScreen('gender');
        }
        
        // Запуск приложения
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>